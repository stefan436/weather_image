<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Aktuelle Messwerte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <!-- THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0px;
      background: #f9fafb;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #111827;
    }

    button {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      background-color: #4f4f4f;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #333;
    }

    #location_output {
      text-align: center;
      margin-bottom: 15px;
      font-style: italic;
    }

    .weather-card {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }

    .weather-data {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .weather-data div {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f1f1f1;
      border-radius: 6px;
    }

    .label {
      font-weight: bold;
      color: #4f4f4f;
    }

    .value {
      color: #111827;
    }

    footer {
      background: #f1f1f1;
      color: #4f4f4f;
      text-align: center;
      padding: 16px;
      margin-top: 40px;
      font-size: 14px;
      border-top: 1px solid #ccc;
    }

    footer p {
      font-size: 10px;
    }

    footer a {
      color: #4f4f4f;
      text-decoration: underline;
    }

    footer a:hover {
      color: #333;
    }

  </style>
</head>
<body>
  <main style="padding: 12px;">
    <h1>Aktuelle Messwerte</h1>
    <button onclick="getLocation(fetchWeather)">Daten laden</button>
    <p id="location_output"></p>

    <div class="weather-card" style="height: 625px;">
      <div class="weather-data" id="weather_data"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <p>
      Sonnenauf- und Untergangszeiten werden lokal berechnet mittels <a href="https://github.com/mourner/suncalc" target="_blank">SunCalc</a>.
    </p>
    <p>
      UV-Index-Daten von <a href="https://currentuvindex.com" target="_blank" rel="noopener noreferrer">currentuvindex.com</a>, lizensiert unter <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC BY 4.0</a>. Daten wurden nicht verändert.
    </p>
    <p>
      Die restlichen Daten wurden über die <a href="https://brightsky.dev/" target="_blank" rel="noopener noreferrer">brightsky.dev</a> geladen, stamme jedoch vom Deutschen Wetterdienst (DWD). Quelle: Deutscher Wetterdienst, lizensiert unter <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC BY 4.0</a>. Daten wurden nicht verändert.
    </p>
  </footer>



  <script>
    const DateTime = luxon.DateTime;
    let source_id = null;

    function getLocation(callback) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => callback(pos.coords.latitude, pos.coords.longitude),
          showError
        );
      } else {
        document.getElementById("location_output").innerText = "Geolocation wird nicht unterstützt.";
      }
    }

    function showError(error) {
      const messages = {
        1: "Zugriff auf Standort verweigert.",
        2: "Standortinformationen nicht verfügbar.",
        3: "Anfrage dauerte zu lange.",
        default: "Unbekannter Fehler."
      };
      document.getElementById("location_output").innerText = messages[error.code] || messages.default;
    }

    function formatValue(value, unit = "") {
      if (value === null || value === undefined || value === "") {
        return "Keine Daten";
      }
      return `${value}${unit}`;
    }

    async function fetchWeather(lat, lon) {
        const proxy = 'https://cors-proxy-for-weather-app.stefan-wiedemann01.workers.dev';
        
        // URLs für Wetter und UV (Sonnen-URL brauchen wir nicht mehr)
        const targetUrlBrightsky = `https://api.brightsky.dev/weather?lat=${lat}&lon=${lon}&date=${DateTime.now().toFormat('yyyy-MM-dd')}`;
        const targetUrlUv = `https://currentuvindex.com/api/v1/uvi?latitude=${lat}&longitude=${lon}`;
        
        const url = `${proxy}?url=${encodeURIComponent(targetUrlBrightsky)}`;
        const url_uv = `${proxy}?url=${encodeURIComponent(targetUrlUv)}`;
    
        // --- TEIL 1: Sonnenaufgang/-untergang BERECHNEN (statt API) ---
        let sunriseFormatted = "Keine Daten";
        let sunsetFormatted = "Keine Daten";
    
        try {
            // SunCalc berechnet die Zeiten basierend auf Datum & Koordinaten
            const times = SunCalc.getTimes(new Date(), lat, lon);
    
            // Die Ergebnisse sind JavaScript Date-Objekte. Wir formatieren sie mit Luxon.
            if (times.sunrise && times.sunset) {
                sunriseFormatted = DateTime.fromJSDate(times.sunrise).toFormat('HH:mm');
                sunsetFormatted = DateTime.fromJSDate(times.sunset).toFormat('HH:mm');
            }
        } catch (e) {
            console.warn("Fehler bei der Sonnenstandsberechnung:", e);
        }
    
        // --- TEIL 2: Wetterdaten laden (Brightsky) ---
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('API-Fehler bei Brightsky: ' + res.status);
            
            const data = await res.json();
            const now = DateTime.now();
    
            const currentHourData = data.weather.find(entry =>
                DateTime.fromISO(entry.timestamp).hour === now.hour
            );
    
            if (!currentHourData) {
                document.getElementById("location_output").innerText = "Keine Wetterdaten gefunden.";
                return;
            }
    
            source_id = currentHourData.source_id;
    
            // --- TEIL 3: UV-Index laden ---
            let uvIndexValue = null;
            try {
                const res_uv = await fetch(url_uv, { headers: { 'Accept': 'application/json' } });
                if (res_uv.ok) {
                    const data_uv = await res_uv.json();
                    uvIndexValue = data_uv?.now?.uvi ?? null;
                }
            } catch (e) {
                console.warn("Fehler beim Laden des UV-Index:", e);
            }
    
            // --- Zusammenstellen der Daten ---
            const fields = {
                "Zeitpunkt": formatValue(
                    DateTime.fromISO(currentHourData.timestamp, { zone: "utc" })
                    .setZone("Europe/Berlin")
                    .toFormat("d. LLLL HH:mm 'Uhr'")
                ),
                "Temperatur": formatValue(currentHourData.temperature?.toFixed(1), "°C"),
                "Niederschlag": formatValue(currentHourData.precipitation, " mm"),
                
                // Hier nutzen wir jetzt die berechneten Werte
                "Sonnenaufgang": sunriseFormatted,
                "Sonnenuntergang": sunsetFormatted,
                
                "Sonnenscheindauer": formatValue(currentHourData.sunshine, " min"),
                "UV-Index": formatValue(uvIndexValue),
                "Bewölkung": formatValue(currentHourData.cloud_cover, "%"),
                "Relative Luftfeuchtigkeit": formatValue(currentHourData.relative_humidity, "%"),
                "Sichtweite": formatValue(currentHourData.visibility, " m"),
                "Niederschlagswahrscheinlichkeit": formatValue(currentHourData.precipitation_probability, "%"),
                "Niederschlagswahrscheinlichkeit (6h)": formatValue(currentHourData.precipitation_probability_6h, "%")
            };
    
            const sourceData = data.sources.find(s => s.id === source_id);
            if (sourceData) {
                fields["Stationsname"] = formatValue(sourceData.station_name);
                fields["Entfernung zur Station"] = formatValue(sourceData.distance, " m");
                fields["Höhe der Station"] = formatValue(sourceData.height, " m");
            }
    
            renderWeather(fields);
    
        } catch (err) {
            console.error("Ein kritischer Fehler ist aufgetreten:", err);
            document.getElementById("location_output").innerText = "Fehler beim Laden der Haupt-Wetterdaten.";
        }
    }


    function renderWeather(fields) {
      const container = document.getElementById("weather_data");
      document.querySelector('.weather-card').style.height = '';
      container.innerHTML = "";
      for (const [label, value] of Object.entries(fields)) {
        const row = document.createElement("div");
        row.innerHTML = `<span class="label">${label}:</span><span class="value">${value}</span>`;
        container.appendChild(row);
      }
      
    }
  </script>
</body>
</html>
