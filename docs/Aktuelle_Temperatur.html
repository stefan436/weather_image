<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Aktuelle Temperatur in München</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f8ff; }
    .temp { font-size: 5em; margin: 0.2em; color: #d9534f; }
    .desc { font-size: 1.2em; color: #555; }
    #icon { width: 100px; height: 100px; }
  </style>
</head>
<body>
  <h1>Aktuelle Temperatur</h1>
  <button onclick="getLocation(fetchWeather)">Daten Laden </button>
  <p id="location_output"></p>
  <img id="icon" alt="Wettersymbol">
  <div class="temp" id="temperature">--°C</div>
  <div class="desc" id="description">Lade …</div>
  <p id="time_data"></p>
  <p id="temp"></p>
  <p id="percipitation"></p>
  <p id="sunshine_duration"></p>
  <p id="cloud_cover"></p>
  <p id="relative_humidity"></p>
  <p id="visibility"></p>
  <p id="perc_prob"></p>
  <p id="perc_prob_6h"></p>
  <p id="station_name"></p>
  <p id="distance_to_station"></p>
  


  <script>
    let lat = 0
    let lon = 0
    let source_id = null
    let DateTime = luxon.DateTime;

    function getLocation(callback) {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          document.getElementById("location_output").innerText = `Breite: ${lat}, Länge: ${lon}`;
          callback(lat, lon); // Jetzt erst fetchWeather aufrufen!
        },
        showError
      );
      } else {
        document.getElementById("location_output").innerText = "Geolocation wird nicht unterstützt.";
      }
    }

    function showPosition(position) {
      lat = position.coords.latitude;
      lon = position.coords.longitude;
      document.getElementById("location_output").innerText = `Breite: ${lat}, Länge: ${lon}`;
    }

    function showError(error) {
      let msg = "";
      switch(error.code) {
        case error.PERMISSION_DENIED: msg = "Zugriff auf Standort verweigert."; break;
        case error.POSITION_UNAVAILABLE: msg = "Standortinformationen nicht verfügbar."; break;
        case error.TIMEOUT: msg = "Anfrage dauerte zu lange."; break;
        case error.UNKNOWN_ERROR: msg = "Unbekannter Fehler."; break;
      }
      document.getElementById("location_output").innerText = msg;
    }

    async function fetchWeather(lat, lon) {
      const url = `https://api.brightsky.dev/weather?lat=${lat}&lon=${lon}&date=${DateTime.now().toFormat('yyyy-MM-dd')}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        const now = DateTime.now()
        const currentHourData = data.weather.find(entry => {
          return DateTime.fromISO(entry.timestamp).hour === now.hour;
        });
 
        if (currentHourData) {
          source_id = currentHourData.source_id
          const time_data = currentHourData.timestamp
          const percipitation = currentHourData.percipitation
          const sunshine_duration = currentHourData.sunshine
          const temp = currentHourData.temperature;
          const cloud_cover = currentHourData.cloud_cover
          const relative_humidity = currentHourData.relative_humidity
          const visibility = currentHourData.visibility
          const perc_prob = currentHourData.precipitation_probability
          const perc_prob_6h = currentHourData.precipitation_probability_6h
          const icon = currentHourData.icon;

          document.getElementById('temp').textContent = `${temp.toFixed(1)}°C`;
          document.getElementById('time_data').textContent = time_data
          document.getElementById('percipitation').textContent = percipitation
          document.getElementById('sunshine_duration').textContent = sunshine_duration
          document.getElementById('cloud_cover').textContent = cloud_cover
          document.getElementById('relative_humidity').textContent = relative_humidity
          document.getElementById('visibility').textContent = visibility
          document.getElementById('perc_prob').textContent = perc_prob
          document.getElementById('perc_prob_6h').textContent = perc_prob_6h
          // document.getElementById('icon').src = `https://cdn.brightsky.dev/icons/${icon}.svg`;
        } else {
          document.getElementById('description').textContent = 'Keine Wetterdaten gefunden';
        }


        const sourceData = data.sources.find(entry => entry.id === source_id);

        if (sourceData) {
          const station_name = sourceData.station_name
          const distance_to_station = sourceData.distance
          document.getElementById('station_name').textContent = station_name
          document.getElementById('distance_to_station').textContent = distance_to_station
        }

      } catch (err) {
        console.error(err);
        document.getElementById('description').textContent = 'Fehler beim Laden der Daten';
      }
    }
  </script>
</body>
</html>
