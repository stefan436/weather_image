<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Aktuelle Temperatur in München</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f0f8ff; }
    .temp { font-size: 5em; margin: 0.2em; color: #d9534f; }
    .desc { font-size: 1.2em; color: #555; }
    #icon { width: 100px; height: 100px; }
  </style>
</head>
<body>
  <h1>Aktuelle Temperatur</h1>
  <button onclick="getLocation()">Standort abrufen</button>
  <button onclick="fetchWeather()">Daten Laden </button>
  <p id="location_output"></p>
  <img id="icon" alt="Wettersymbol">
  <div class="temp" id="temperature">--°C</div>
  <div class="desc" id="description">Lade …</div>

  <script>
    let lat = 0
    let lon = 0
    let DateTime = luxon.DateTime;

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        document.getElementById("location_output").innerText = "Geolocation wird nicht unterstützt.";
      }
    }

    function showPosition(position) {
      lat = position.coords.latitude;
      lon = position.coords.longitude;
      document.getElementById("location_output").innerText = `Breite: ${lat}, Länge: ${lon}`;
    }

    function showError(error) {
      let msg = "";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          msg = "Zugriff auf Standort verweigert.";
          break;
        case error.POSITION_UNAVAILABLE:
          msg = "Standortinformationen nicht verfügbar.";
          break;
        case error.TIMEOUT:
          msg = "Anfrage dauerte zu lange.";
          break;
        case error.UNKNOWN_ERROR:
          msg = "Unbekannter Fehler.";
          break;
      }
      document.getElementById("location_output").innerText = msg;
    }

    async function fetchWeather() {
      const url = `https://api.brightsky.dev/weather?lat=${lat}&lon=${lon}&date=${DateTime.now().toFormat('yyyy-MM-dd')}`;
      try {
        const response = await fetch(url);
        const data = await response.json();

        const now = DateTime.now();
        const currentHourData = data.weather.find(entry => {
            return DateTime.fromISO(entry.timestamp).hour === now.hour;
        });
        if (currentHourData) {
        const temp = currentHourData.temperature;
        const condition = currentHourData.condition;
        const icon = currentHourData.icon;

        document.getElementById('temperature').textContent = `${temp.toFixed(1)}°C`;
        document.getElementById('description').textContent = condition;
        document.getElementById('icon').src = `https://cdn.brightsky.dev/icons/${icon}.svg`;
        } else {
        document.getElementById('description').textContent = 'Keine Wetterdaten gefunden';
        }

      } catch (err) {
        console.error(err);
        document.getElementById('description').textContent = 'Fehler beim Laden der Daten';
      }
    }

  </script>
</body>
</html>
