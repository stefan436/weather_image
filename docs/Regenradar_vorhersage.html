<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>RV Komposit Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Externe Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/js-untar@2.0.0/build/dist/untar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/h5wasm@0.8.3/dist/iife/h5wasm.min.js"></script>
  <script src="MarchingSquares.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.19.10/dist/proj4.min.js"></script>





  <style>
    body, html { margin: 0; padding: 0; height: 100%; display: flex; flex-direction: column; }
    #controls { padding: 10px; background: #f0f0f0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #map { flex: 1 1 auto; }
    .legend { position: absolute; bottom: 30px; right: 20px; padding: 10px; background: white;
              line-height: 1.2em; font-size: 14px; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 1000; }
    .legend .scale {
      width: 200px; height: 12px;
      background: linear-gradient(to right,#00007F 0%,#0000FF 15%,#007FFF 30%,#00FF00 50%,#FFFF00 70%,#FF7F00 85%,#FF0000 100%);
      margin-bottom: 5px;
    }
    .legend .labels { display: flex; justify-content: space-between; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="start">RV Daten laden & animieren</button>
    <input id="frameSlider" type="range" min="0" max="24" value="0" style="width:300px;" disabled>
    <span id="frameLabel">Frame: 0</span>
    <pre id="output" style="max-height:100px; overflow:auto;"></pre>
  </div>
  <div id="map"></div>
  <div id="legend" class="legend" style="display:none;">
    <div class="scale"></div>
    <div class="labels"><span id="minLabel">1 mm/h</span><span id="maxLabel">20 mm/h</span></div>
  </div>

<script>
const DateTime = luxon.DateTime;
const map = L.map('map').setView([51, 10], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
map.createPane('contourPane');
map.getPane('contourPane').style.zIndex = 450;
map.getPane('contourPane').style.mixBlendMode = 'multiply';

const output = document.getElementById('output');
const frameSlider = document.getElementById('frameSlider');
const frameLabel = document.getElementById('frameLabel');

const colorScale = chroma.scale(['#00007F','#0000FF','#007FFF','#00FF00','#FFFF00','#FF7F00','#FF0000']).domain([0,20]);
const contourLevels = [0.5, 1, 2, 3, 4, 5, 6, 8, 10, 12, 15, 20];

let frames = [];
let latGrid, lonGrid;
let contourLayers = [];
let nx, ny;
let lat, lon;


  
// HDF5-Datei parsen
async function parseH5File(buffer) {
    await h5wasm.ready;
    const filename = "/tmp.h5";
    h5wasm.FS.writeFile(filename, new Uint8Array(buffer));
    const file = new h5wasm.File(filename, "r");

    // Rasterdaten
    const dataSet = file.get("/dataset1/data1/data");
    const shape = dataSet.shape;
    const raw = dataSet.to_array();

    // Nodata
    const what = file.get("/dataset1/data1/what");
    const nodata = what.attrs['nodata'].value;

    file.close();

    // Werte skalieren (mm/h)
    const data = raw.map(row =>
      row.map(v => (v === nodata ? 0 : (v * 0.01) * 12))
    );
    
    return {data};
}

function createCoords() {
    // Georeferenzierung
    const projDef = "+proj=stere +lat_ts=60 +lat_0=90 +lon_0=10 +x_0=542962.16692185658 +y_0=3609144.7242655745 +units=m +a=6370040 +b=6370040 +no_defs";
    const xsize = 1100;
    const ysize = 1200;
    const xscale = 1000;
    const yscale = 1000;

    // Koordinatenraster erzeugen
    proj4.defs("DWDPROJ", projDef);
    const lat = [], lon = [];
    for (let y = 0; y < ysize; y++) {
        const rowLat = [], rowLon = [];
        for (let x = 0; x < xsize; x++) {
            const X = x * xscale;
            const Y = y * yscale;
            const [lng, latVal] = proj4("DWDPROJ", "WGS84", [X, Y]);
            rowLat.push(latVal);
            rowLon.push(lng);
        }
        lat.push(rowLat);
        lon.push(rowLon);
    }
    return {lon, lat}
}


    

// Konvertiere Indices zu Lat/Lon
function convertIndicesToLatLon(line, latGrid, lonGrid) {
    return line.map(([x, y]) => {
        const xi = Math.round(x), yi = Math.round(y);
        if (yi>=0 && yi<latGrid.length && xi>=0 && xi<latGrid[0].length)
            return [latGrid[yi][xi], lonGrid[yi][xi]];
        return null;
    }).filter(pt => pt !== null);
}
function isClosed(coords) {
    if (coords.length < 3) return false;
    const [lat1, lon1] = coords[0];
    const [lat2, lon2] = coords[coords.length - 1];
    return Math.hypot(lat1 - lat2, lon1 - lon2) < 0.0001;
}
function isLargeOutline(line, width, height) {
    const xs = line.map(([x,_])=>x), ys=line.map(([_,y])=>y);
    return (Math.max(...xs)-Math.min(...xs) > 0.9*width && Math.max(...ys)-Math.min(...ys) > 0.9*height);
}

// Frame rendern
function renderFrame(idx) {
    contourLayers.forEach(l => map.removeLayer(l));
    contourLayers = [];
    const raster = frames[idx];
    const ny = lat.length;
    const nx = lat[0].length;
    contourLevels.forEach(level=>{
        const lines = MarchingSquaresJS.isoLines(raster, level, { noQuadTree: true });
        lines.forEach(line=>{
            if (isLargeOutline(line, nx, ny)) return;
            const geoLines = convertIndicesToLatLon(line, lat, lon);
            if (isClosed(geoLines)) {
                contourLayers.push(L.polygon(geoLines,{pane:'contourPane',color:colorScale(level).hex(),fillColor:colorScale(level).hex(),fillOpacity:0.4,weight:1}).addTo(map));
            } else {
                contourLayers.push(L.polyline(geoLines,{pane:'contourPane',color:colorScale(level).hex(),weight:2,opacity:1}).addTo(map));
            }
        });
    });
    frameLabel.textContent = `Frame ${idx+1}/${frames.length}`;
}


// Hauptfunktion: Laden & Verarbeiten
async function fetchAndProcessComposite() {
    try {
        output.textContent = "Lade composite_rv_LATEST.tar ...\n";
        const proxy = 'https://corsproxy.io/?';
        const tarUrl = `${proxy}https://opendata.dwd.de/weather/radar/composite/rv/composite_rv_LATEST.tar`;
        const resp = await fetch(tarUrl);
        if(!resp.ok) throw new Error("Download fehlgeschlagen");
        const arrayBuffer = await resp.arrayBuffer();

        const entries = await untar(arrayBuffer);
        entries.sort((a,b)=>a.name.localeCompare(b.name)); // sortieren
        output.textContent += `Gefundene Dateien: ${entries.length}\n`;

        for (let i = 0; i < entries.length; i++) {
            const parsed = await parseH5File(entries[i].buffer);
            parsed.data.reverse();
            frames.push(parsed.data);
        } 

        const coords = createCoords();
        lat = coords.lat;
        lon = coords.lon;
        console.log(Math.max(...lat))
        console.log(Math.max(...lon))



        output.textContent += "Frames geladen: "+frames.length+"\n";
        frameSlider.max = frames.length-1;
        frameSlider.disabled = false;
        document.getElementById('legend').style.display = 'block';
        renderFrame(0);
    } catch(e) {
        output.textContent += "Fehler: "+e.message+"\n";
        console.error(e);
    }
}

// Event Listener
document.getElementById('start').addEventListener('click', fetchAndProcessComposite);
frameSlider.addEventListener('input', e => renderFrame(parseInt(e.target.value)));
</script>
</body>
</html>
